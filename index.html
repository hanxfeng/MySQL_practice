<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿å­¦ä¹ å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        [v-cloak] { display: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        body { background-color: #f3f4f6; }
    </style>
</head>
<body>

<div id="app" v-cloak class="min-h-screen flex flex-col">

    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center cursor-pointer" @click="goHome">
                    <span class="text-xl font-bold text-indigo-600">LearningHub</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div v-if="isLoggedIn" class="flex items-center space-x-4">
                        <span class="text-gray-600 text-sm">ç”¨æˆ·ID: {{ userId }}</span>
                        <button @click="showFavorites" class="text-gray-600 hover:text-indigo-600">æˆ‘çš„æ”¶è—</button>
                        <button @click="logout" class="text-red-500 hover:text-red-700 text-sm">é€€å‡º</button>
                    </div>
                    <div v-else>
                        <span class="text-sm text-gray-500">è¯·å…ˆç™»å½•</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-6">

        <transition name="fade" mode="out-in">
            <div v-if="!isLoggedIn" key="login" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg mt-10">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">æ¬¢è¿ç™»å½•</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">é‚®ç®±</label>
                        <input type="email" v-model="loginForm.email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="admin@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å¯†ç </label>
                        <input type="password" v-model="loginForm.password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="******">
                    </div>
                    <button @click="handleLogin" :disabled="loading" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
                        {{ loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
                    </button>
                </div>
                <p class="mt-4 text-xs text-center text-gray-400">æµ‹è¯•è´¦å·è¯·ç¡®ä¿æ•°æ®åº“ä¸­æœ‰æ•°æ®</p>
            </div>

            <div v-else-if="currentView === 'list'" key="list">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">{{ showFavsOnly ? 'æˆ‘çš„æ”¶è—' : 'è¯¾ç¨‹å¤§å…' }}</h2>
                    <div class="flex space-x-2" v-if="!showFavsOnly">
                        <input v-model="searchKeyword" @keyup.enter="fetchCourses" type="text" placeholder="æœç´¢è¯¾ç¨‹..." class="border rounded-md px-3 py-1 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button @click="fetchCourses" class="bg-indigo-600 text-white px-4 py-1 rounded-md hover:bg-indigo-700">æœç´¢</button>
                    </div>
                </div>

                <div v-if="loading" class="text-center py-10 text-gray-500">åŠ è½½ä¸­...</div>

                <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div v-for="course in courses" :key="course.id" @click="viewDetail(course.id)" class="bg-white rounded-lg shadow hover:shadow-xl transition-shadow cursor-pointer overflow-hidden border border-gray-100">
                        <div class="h-40 bg-gray-200 bg-cover bg-center" :style="{backgroundImage: `url(${course.cover_url || 'https://via.placeholder.com/400x200?text=Course'})`}"></div>
                        <div class="p-4">
                            <h3 class="text-lg font-bold text-gray-900 truncate">{{ course.title }}</h3>
                            <div class="flex justify-between items-center mt-3">
                                <span class="text-red-500 font-bold">Â¥ {{ course.price }}</span>
                                <span class="text-xs text-gray-500">{{ course.student_count }} äººåœ¨å­¦</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="courses.length === 0 && !loading" class="text-center py-10 text-gray-400">
                    æš‚æ— è¯¾ç¨‹æ•°æ®
                </div>
            </div>

            <div v-else-if="currentView === 'detail' && currentCourse" key="detail" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="md:flex">
                    <div class="md:w-1/3">
                        <img :src="currentCourse.cover_url || 'https://via.placeholder.com/400x300'" class="w-full h-full object-cover">
                    </div>
                    <div class="p-8 md:w-2/3 flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start">
                                <h1 class="text-3xl font-bold text-gray-900">{{ currentCourse.title }}</h1>
                                <button @click="toggleFavorite" class="text-2xl focus:outline-none transition transform hover:scale-110">
                                    {{ isFavorite ? 'â¤ï¸' : 'ğŸ¤' }}
                                </button>
                            </div>
                            <p class="mt-4 text-gray-600">{{ currentCourse.description || 'æš‚æ— ç®€ä»‹' }}</p>
                            <div class="mt-4 flex items-center space-x-4">
                                <span class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm">è®²å¸ˆ: {{ currentCourse.teacher.username }}</span>
                                <span class="text-gray-500 text-sm">Email: {{ currentCourse.teacher.email }}</span>
                            </div>
                        </div>
                        <div class="mt-8 flex items-center justify-between border-t pt-4">
                            <div class="text-3xl font-bold text-red-500">Â¥ {{ currentCourse.price }}</div>
                            <button @click="buyCourse" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-8 rounded-full shadow-lg transform transition hover:-translate-y-0.5">
                                ç«‹å³è´­ä¹°
                            </button>
                        </div>
                    </div>
                </div>

                <div class="px-8 py-6 bg-gray-50 border-t">
                    <div class="flex space-x-6 border-b mb-4">
                        <button @click="activeTab = 'lessons'" :class="{'border-b-2 border-indigo-600 text-indigo-600': activeTab === 'lessons'}" class="pb-2 font-medium text-gray-600 hover:text-indigo-600">è¯¾ç¨‹ç« èŠ‚</button>
                        <button @click="loadComments" :class="{'border-b-2 border-indigo-600 text-indigo-600': activeTab === 'comments'}" class="pb-2 font-medium text-gray-600 hover:text-indigo-600">å­¦å‘˜è¯„ä»·</button>
                    </div>

                    <div v-if="activeTab === 'lessons'">
                        <ul class="space-y-3">
                            <li v-for="lesson in currentCourse.lessons" :key="lesson.id" class="flex justify-between items-center bg-white p-3 rounded border hover:bg-gray-50">
                                <div class="flex items-center">
                                    <span class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-xs mr-3">{{ lesson.id }}</span>
                                    <span>{{ lesson.title }}</span>
                                </div>
                                <button @click="alert('è¯·å…ˆè´­ä¹°åè§‚çœ‹ï¼ˆæ¨¡æ‹Ÿæ’­æ”¾ï¼‰')" class="text-indigo-600 text-sm hover:underline">æ’­æ”¾</button>
                            </li>
                            <li v-if="currentCourse.lessons.length === 0" class="text-gray-400">æš‚æ— ç« èŠ‚</li>
                        </ul>
                    </div>

                    <div v-if="activeTab === 'comments'">
                        <div class="mb-4 flex space-x-2">
                            <input v-model="newComment" placeholder="å†™ä¸‹ä½ çš„è¯„ä»·..." class="flex-grow border rounded p-2 text-sm">
                            <select v-model="newRating" class="border rounded p-2 text-sm">
                                <option value="5">5åˆ†</option>
                                <option value="4">4åˆ†</option>
                                <option value="3">3åˆ†</option>
                                <option value="2">2åˆ†</option>
                                <option value="1">1åˆ†</option>
                            </select>
                            <button @click="addComment" class="bg-indigo-600 text-white px-4 rounded text-sm">å‘å¸ƒ</button>
                        </div>
                        <div class="space-y-4">
                            <div v-for="(comment, idx) in comments" :key="idx" class="bg-white p-4 rounded border">
                                <div class="flex justify-between text-sm text-gray-500 mb-1">
                                    <span>{{ comment.username }}</span>
                                    <span>{{ new Date(comment.created_at).toLocaleDateString() }}</span>
                                </div>
                                <div class="text-yellow-500 text-sm mb-1">
                                    {{ 'â˜…'.repeat(comment.rating) }}{{ 'â˜†'.repeat(5-comment.rating) }}
                                </div>
                                <p class="text-gray-800">{{ comment.content }}</p>
                            </div>
                            <div v-if="comments.length === 0" class="text-gray-400 text-center">æš‚æ— è¯„è®º</div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

    </main>
</div>

<script>
const { createApp, ref, reactive, computed, onMounted } = Vue;

const API_BASE = 'http://127.0.0.1:5000/api';

createApp({
    setup() {
        const token = ref(localStorage.getItem('token') || '');
        const userId = ref(''); // JWTè§£ç åçš„IDé€šå¸¸å­˜åœ¨å‰ç«¯çŠ¶æ€ä¸­ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
        const loading = ref(false);
        const currentView = ref('list'); // 'login', 'list', 'detail'
        const showFavsOnly = ref(false);

        // è¡¨å•ä¸æ•°æ®
        const loginForm = reactive({ email: '', password: '' });
        const searchKeyword = ref('');
        const courses = ref([]);
        const currentCourse = ref(null);
        const activeTab = ref('lessons');
        const isFavorite = ref(false);
        const comments = ref([]);
        const newComment = ref('');
        const newRating = ref(5);

        // è®¡ç®—å±æ€§
        const isLoggedIn = computed(() => !!token.value);

        // åˆå§‹åŒ– Axios æ‹¦æˆªå™¨
        axios.interceptors.request.use(config => {
            if (token.value) {
                config.headers.Authorization = `Bearer ${token.value}`;
            }
            return config;
        });

        // JWT è§£æç®€åŒ–ç‰ˆ
        const parseJwt = (token) => {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) { return null; }
        };

        if (token.value) {
            const payload = parseJwt(token.value);
            if(payload) userId.value = payload.user_id;
            fetchCourses();
        }

        // --- æ–¹æ³• ---

        async function handleLogin() {
            loading.value = true;
            try {
                const res = await axios.post(`${API_BASE}/login`, loginForm);
                if (res.data.success) {
                    token.value = res.data.token;
                    localStorage.setItem('token', token.value);
                    const payload = parseJwt(token.value);
                    userId.value = payload.user_id;
                    // é‡ç½®çŠ¶æ€
                    showFavsOnly.value = false;
                    fetchCourses();
                }
            } catch (error) {
                alert(error.response?.data?.message || 'ç™»å½•å¤±è´¥');
            } finally {
                loading.value = false;
            }
        }

        function logout() {
            token.value = '';
            localStorage.removeItem('token');
            courses.value = [];
            currentView.value = 'list';
        }

        function goHome() {
            if (!isLoggedIn.value) return;
            currentView.value = 'list';
            showFavsOnly.value = false;
            currentCourse.value = null;
            fetchCourses();
        }

        async function fetchCourses() {
            if (!isLoggedIn.value) return;
            loading.value = true;
            try {
                const url = showFavsOnly.value ? `${API_BASE}/get_favorites` : `${API_BASE}/course_list`;
                const payload = showFavsOnly.value ? { page: 1 } : { page: 1, keyword: searchKeyword.value };

                const res = await axios.post(url, payload);
                courses.value = res.data.data;
                currentView.value = 'list';
            } catch (error) {
                console.error(error);
                alert('è·å–è¯¾ç¨‹åˆ—è¡¨å¤±è´¥');
            } finally {
                loading.value = false;
            }
        }

        function showFavorites() {
            showFavsOnly.value = true;
            fetchCourses();
        }

        async function viewDetail(courseId) {
            loading.value = true;
            try {
                // 1. è·å–è¯¦æƒ…
                const res = await axios.post(`${API_BASE}/course_detail`, { course_id: courseId });
                currentCourse.value = res.data.data;

                // 2. æ£€æŸ¥æ”¶è—çŠ¶æ€ (è¿™é‡Œå·æ‡’ç”¨favoritesåˆ—è¡¨æ£€æŸ¥ï¼Œå› ä¸ºAPIæ²¡æä¾›is_favå­—æ®µ)
                // å®é™…é¡¹ç›®ä¸­å»ºè®®åç«¯detailæ¥å£è¿”å› is_favorite
                checkIfFavorite(courseId);

                currentView.value = 'detail';
                activeTab.value = 'lessons';
            } catch (error) {
                alert(error.response?.data?.message || 'è·å–è¯¦æƒ…å¤±è´¥');
            } finally {
                loading.value = false;
            }
        }

        // è¾…åŠ©æ£€æŸ¥æ˜¯å¦æ”¶è— (Mockè¡Œä¸ºï¼Œå› ä¸ºåç«¯æœªç›´æ¥æä¾›å•æ¡æŸ¥è¯¢)
        async function checkIfFavorite(courseId) {
             // ç®€å•èµ·è§ï¼Œè¿™é‡Œé»˜è®¤ä¸ºfalseï¼Œç‚¹å‡»æ”¶è—æŒ‰é’®æ—¶ä¼šè°ƒç”¨APIåˆ‡æ¢
             isFavorite.value = false;
        }

        async function buyCourse() {
            if (!confirm(`ç¡®è®¤èŠ±è´¹ Â¥${currentCourse.value.price} è´­ä¹°å—ï¼Ÿ`)) return;
            try {
                const res = await axios.post(`${API_BASE}/buy_course`, { course_id: currentCourse.value.id });
                alert(res.data.message);
            } catch (error) {
                alert(error.response?.data?.message || 'è´­ä¹°å¤±è´¥');
            }
        }

        async function toggleFavorite() {
            try {
                const res = await axios.post(`${API_BASE}/favorite_course`, { course_id: currentCourse.value.id });
                alert(res.data.message);
                isFavorite.value = !isFavorite.value;
            } catch (error) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        async function loadComments() {
            activeTab.value = 'comments';
            try {
                const res = await axios.post(`${API_BASE}/get_comments`, { course_id: currentCourse.value.id, page: 1 });
                comments.value = res.data.data;
            } catch (error) {
                console.error(error);
            }
        }

        async function addComment() {
            if(!newComment.value) return alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
            try {
                await axios.post(`${API_BASE}/add_comment`, {
                    course_id: currentCourse.value.id,
                    rating: parseInt(newRating.value),
                    content: newComment.value
                });
                alert('è¯„è®ºæˆåŠŸ');
                newComment.value = '';
                loadComments(); // åˆ·æ–°
            } catch (error) {
                alert(error.response?.data?.message || 'è¯„è®ºå¤±è´¥ï¼Œè¯·ç¡®è®¤æ˜¯å¦å·²è´­ä¹°');
            }
        }

        return {
            token, userId, isLoggedIn, loading, currentView,
            loginForm, searchKeyword, courses, currentCourse,
            activeTab, isFavorite, showFavsOnly, comments, newComment, newRating,
            handleLogin, logout, goHome, fetchCourses, showFavorites,
            viewDetail, buyCourse, toggleFavorite, loadComments, addComment
        };
    }
}).mount('#app');
</script>
</body>
</html>